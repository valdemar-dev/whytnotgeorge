(()=>{window.__name=r=>r;globalThis.pd||(globalThis.pd={});var j=new DOMParser,L=new XMLSerializer,k=new Map,$=window.location,h=document,v=[],M=Array.from,m=r=>!r.endsWith("/")||r==="/"?r:r.slice(0,-1),P=m($.pathname),D=r=>{const s={subjects:r.map(a=>{const t={...a,observers:new Map};return t.signal=()=>{for(const n of t.observers.values())try{n(t.value)}catch{continue}},t}),get:(a,t)=>t?pd[t].get(a):s.subjects.find(n=>n.id===a),getAll:a=>a?.map(t=>t.bind?pd[t.bind].get(t.id):s.get(t.id)),observe:(a,t,n)=>{a.observers.delete(n),a.observers.set(n,t)}};return s},B=(r=[],s)=>{const a=new URL($.href);a.pathname=m(a.pathname);const t=a.pathname;history.replaceState(null,"",a.href);let n=pd[t];if(pd===void 0)return;for(const[e,i]of Object.entries(n.binds||{})){if(!pd[e]){pd[e]=D(i);continue}const l=pd[e],u=i;for(const g of u)l.get(g.id)||pd[e].subjects.push(g)}let c=n.stateManager;c||(c=D(n.state||[]),n.stateManager=c);for(const e of c.subjects)e.observers=new Map;for(const e of n.ooa||[]){const i=h.querySelector(`[key="${e.key}"]`);let l={};for(const{id:u,bind:g}of e.refs){const d=c.get(u,g);l[d.id]=d.value;const b=y=>{l[u]=y;try{const S=e.update(...Object.values(l));let A=e.attribute==="class"?"className":e.attribute;i[A]=S}catch{return}};b(d.value);try{c.observe(d,b,e.key)}catch{return}}}for(const e of n.soa||[]){const i=h.querySelector(`[key="${e.key}"]`),l=c.get(e.id,e.bind);if(typeof l.value=="function")try{i[e.attribute]=u=>l.value(c,u)}catch{return}else i[e.attribute]=l.value}const w=n.lh;for(const e of w||[]){const i=e.bind;if(i!==void 0&&s&&!s.includes(`${i}`))continue;const l=e.fn;try{let u;l.constructor.name==="AsyncFunction"?l(c).then(d=>{d&&v.push({cleanupFunction:d,bind:`${i}`})}):(u=l(c),u&&v.push({cleanupFunction:u,bind:`${i}`}))}catch{return}}k.set(P,L.serializeToString(h))},x=async r=>{const s=m(r.pathname);if(k.has(s))return j.parseFromString(k.get(s),"text/html");const a=await fetch(r),t=j.parseFromString(await a.text(),"text/html"),n=t.querySelector('script[data-tag="true"]');if(n){if(!pd[s]){const{data:c}=await import(n.src);pd[s]=c}return k.set(s,L.serializeToString(t)),t}},F=async(r,s=!0)=>{const a=new URL(r),t=m(a.pathname);let n=await x(a);if(!n||t===P)return;const c=M(h.querySelectorAll("div[bp]")),w=c.map(o=>o.getAttribute("bp")),e=M(n.querySelectorAll("div[bp]")),i=e.map(o=>o.getAttribute("bp")),l=(o,p)=>{let f=0;const O=Math.min(o.length,p.length);for(;f<O&&o[f].getAttribute("bp")===p[f].getAttribute("bp");)f++;return f>0?[o[f-1],p[f-1]]:[document.body,n.body]},[u,g]=l(c,e),d=[],b=u.getAttribute("key"),y=o=>{const p=o.getAttribute("key");if(p&&d.push(p),!(p===b||!b))for(const f of M(o.children))y(f)};y(h.body);const S=w.filter(o=>!i.includes(o)),A=i.filter(o=>!w.includes(o));for(const o of[...v]){const p=o.bind;if(p.length<1||S.includes(p)){try{o.cleanupFunction()}catch{return}v.splice(v.indexOf(o),1)}}u.replaceWith(g),h.head.replaceWith(n.head),s&&history.pushState(null,"",a.href),P=t,a.hash&&h.getElementById(a.hash.slice(1))?.scrollIntoView(),B(d,A)};window.onpopstate=async r=>{r.preventDefault();const s=r.target;await F(s.location.href,!1),history.replaceState(null,"",s.location.href)};globalThis.client={navigateLocally:F,fetchPage:x,currentPage:P,sanitizePathname:m,getReference:r=>document.querySelector(`[ref="${r}"]`)};try{B()}catch{}})();

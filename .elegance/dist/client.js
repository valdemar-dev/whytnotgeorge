(()=>{window.__name=a=>a;globalThis.pd||(globalThis.pd={});const L=new DOMParser,D=new XMLSerializer,k=new Map,T=window.location,h=document;let m=[];const A=Array.from,v=a=>!a.endsWith("/")||a==="/"?a:a.slice(0,-1);let P=v(T.pathname);const M=a=>{const s={subjects:a.map(n=>{const t={...n,observers:new Map};return t.signal=()=>{for(const o of t.observers.values())try{o(t.value)}catch{continue}},t}),get:(n,t)=>t?pd[t].get(n):s.subjects.find(o=>o.id===n),getAll:n=>n?.map(t=>t.bind?pd[t.bind].get(t.id):s.get(t.id)),observe:(n,t,o)=>{n.observers.delete(o),n.observers.set(o,t)}};return s},$=(a=[],s)=>{const n=new URL(T.href);n.pathname=v(n.pathname);const t=n.pathname;history.replaceState(null,"",n.href);let o=pd[t];if(pd===void 0)return;for(const[e,c]of Object.entries(o.binds||{})){if(!pd[e]){pd[e]=M(c);continue}const l=pd[e],u=c;for(const f of u)l.get(f.id)||pd[e].subjects.push(f)}let i=o.stateManager;i||(i=M(o.state||[]),o.stateManager=i);for(const e of i.subjects)e.observers=new Map;for(const e of o.ooa||[]){const c=h.querySelector(`[key="${e.key}"]`);let l={};for(const{id:u,bind:f}of e.refs){const d=i.get(u,f);l[d.id]=d.value;const b=y=>{l[u]=y;try{const S=e.update(...Object.values(l));let j=e.attribute==="class"?"className":e.attribute;c[j]=S}catch{return}};b(d.value);try{i.observe(d,b,e.key)}catch{return}}}for(const e of o.soa||[]){const c=h.querySelector(`[key="${e.key}"]`),l=i.get(e.id,e.bind);if(typeof l.value=="function")try{c[e.attribute]=u=>l.value(i,u)}catch{return}else c[e.attribute]=l.value}const w=o.lh;for(const e of w||[]){const c=e.bind;if(c!==void 0&&s&&!s.includes(`${c}`))continue;const l=e.fn;try{let u;l.constructor.name==="AsyncFunction"?l(i).then(d=>{d&&m.push({cleanupFunction:d,bind:`${c}`})}):(u=l(i),u&&m.push({cleanupFunction:u,bind:`${c}`}))}catch{return}}k.set(P,D.serializeToString(h))},B=async a=>{const s=v(a.pathname);if(k.has(s))return L.parseFromString(k.get(s),"text/html");const n=await fetch(a),t=L.parseFromString(await n.text(),"text/html"),o=t.querySelector('script[data-tag="true"]');if(o){if(!pd[s]){const{data:i}=await import(o.src);pd[s]=i}return k.set(s,D.serializeToString(t)),t}},E=async(a,s=!0)=>{const n=new URL(a),t=v(n.pathname);let o=await B(n);if(!o||t===P)return;const i=A(h.querySelectorAll("div[bp]")),w=i.map(r=>r.getAttribute("bp")),e=A(o.querySelectorAll("div[bp]")),c=e.map(r=>r.getAttribute("bp")),l=(r,p)=>{let g=0;const H=Math.min(r.length,p.length);for(;g<H&&r[g].getAttribute("bp")===p[g].getAttribute("bp");)g++;return g>0?[r[g-1],p[g-1]]:[document.body,o.body]},[u,f]=l(i,e),d=[],b=u.getAttribute("key"),y=r=>{const p=r.getAttribute("key");if(p&&d.push(p),!(p===b||!b))for(const g of A(r.children))y(g)};y(h.body);const S=w.filter(r=>!c.includes(r)),j=c.filter(r=>!w.includes(r));for(const r of[...m]){const p=r.bind;if(p.length<1||S.includes(p)){try{r.cleanupFunction()}catch{return}m.splice(m.indexOf(r),1)}}u.replaceWith(f),h.head.replaceWith(o.head),s&&history.pushState(null,"",n.href),P=t,n.hash&&h.getElementById(n.hash.slice(1))?.scrollIntoView(),$(d,j)};window.onpopstate=async a=>{a.preventDefault();const s=a.target;await E(s.location.href,!1),history.replaceState(null,"",s.location.href)};globalThis.client={navigateLocally:E,fetchPage:B,currentPage:P,sanitizePathname:v,getReference:a=>document.querySelector(`[ref="${a}"]`)};try{$()}catch{}})();
